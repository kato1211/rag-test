# .github/workflows/mirror-to-codecommit.yml（git-remote-codecommit版）
name: Mirror to AWS CodeCommit

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"
  push:
    branches:
      - "**"

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout GitHub repo (kato1211/rag-test)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::392976832481:role/rag-git-test
          aws-region: ap-northeast-1

      - name: Install git-remote-codecommit helper
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3-pip
          pip3 install git-remote-codecommit

      - name: Verify caller identity (debug)
        run: aws sts get-caller-identity

      - name: Add CodeCommit remote and mirror-push (git-remote-codecommit)
        env:
          AWS_REGION: ap-northeast-1
          ACCOUNT_ID: 392976832481
          CC_REPO: rag-test-mirror
        run: |
          # 専用URL（git-remote-codecommitプラグインを利用）
          CC_URL="codecommit::$AWS_REGION://$ACCOUNT_ID/$CC_REPO"
          git remote add mirror "$CC_URL" || git remote set-url mirror "$CC_URL"
          git push --prune --mirror mirror
