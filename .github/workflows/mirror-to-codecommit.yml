# .github/workflows/mirror-to-codecommit.yml
name: Mirror to AWS CodeCommit

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"
  push:
    branches:
      - "**"

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout GitHub repo (kato1211/rag-test)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::392976832481:role/rag-git-test
          aws-region: ap-northeast-1

      - name: Configure git credential helper for CodeCommit (HTTPS)
        run: |
          git config --global credential.helper '!aws codecommit credential-helper $@'
          git config --global credential.UseHttpPath true

      - name: Verify caller identity (debug)
        run: aws sts get-caller-identity

      - name: Add CodeCommit remote and mirror-push (HTTPS)
        env:
          AWS_REGION: ap-northeast-1
          CC_REPO: rag-test-mirror
        run: |
          # 正しいHTTPS URL（リポジトリ名を使用）
          CC_URL="https://git-codecommit.$AWS_REGION.amazonaws.com/v1/repos/$CC_REPO"
          git remote remove mirror || true
          git remote add mirror "$CC_URL"
          git remote -v
          git push --prune --mirror mirror
